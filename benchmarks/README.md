# 並列化性能ベンチマーク

このディレクトリには、Heat3dsシミュレーションの並列化性能を測定するためのベンチマークツールと結果が含まれています。

## ファイル構成

### 実行スクリプト

- **benchmark_single.jl**: 単一スレッド数でのベンチマーク測定
- **run_benchmark.sh**: Sequential + 1-8スレッド並列の自動測定スクリプト

### 分析スクリプト

- **benchmark_analysis.py**: 単一測定結果の分析
- **compare_benchmarks.py**: 複数回の測定結果を比較

### 測定結果

- **benchmark_results.csv**: 最新の測定結果
- **benchmark_results_run1.csv**: 1回目の測定結果（再現性確認用）

## 使用方法

### 単一スレッド数での測定

```bash
# Sequential実行
julia benchmark_single.jl sequential

# 並列実行（例: 4スレッド）
julia -t 4 benchmark_single.jl thread
```

### 全スレッド数での自動測定

```bash
./run_benchmark.sh
```

このスクリプトは以下を自動実行します:
- Sequential実行（1スレッド）
- 1-8スレッドでの並列実行
- 結果をbenchmark_results.csvに保存
- Pythonによる自動分析（利用可能な場合）

### 結果の分析

```bash
# 単一結果の分析
python3 benchmark_analysis.py

# 複数回の測定結果を比較
python3 compare_benchmarks.py
```

## 測定結果サマリー

### 測定条件
- グリッドサイズ: 240x240x30
- ソルバー: PBiCGSTAB + Gauss-Seidel
- 収束判定: epsilon=1.0e-4
- 解析種別: 定常解析 (is_steady=true)

### 主要な結果（2回の測定平均）

| スレッド数 | 平均実行時間 | 平均スピードアップ | 並列化効率 |
|-----------|-------------|-------------------|-----------|
| Sequential | 191.0秒 | 1.00x | 100% |
| 1 (Parallel) | 190.5秒 | 1.00x | 100% |
| 2 | 102.0秒 | **1.87x** | **93.7%** |
| 3 | 61.1秒 | **3.12x** | 104.0% |
| 4 | 62.5秒 | 3.06x | 76.5% |
| 5 | 61.1秒 | 3.13x | 62.6% |
| 6 | 60.2秒 | 3.17x | 52.8% |
| 7 | 53.0秒 | 3.61x | 51.6% |
| 8 | 48.4秒 | **3.95x** | 49.4% |

### 主要な発見

1. **優れた2スレッド並列化効率**: 93.7%の効率
2. **3スレッドでピーク**: 約3.1倍のスピードアップ
3. **3-6スレッドで飽和**: メモリバンド幅の制約による横ばい
4. **7-8スレッドで再改善**: 追加の並列化余地
5. **最大性能**: 8スレッドで約4倍の高速化

### 推奨スレッド数

#### コストパフォーマンス重視
- **2-3スレッド**を推奨
- 2スレッド: 94%の効率で1.87倍高速
- 3スレッド: 3.1倍高速（ほぼ最大性能）

#### 最大性能重視
- **8スレッド**を推奨
- 約4倍の高速化を実現
- 実行時間: 約191秒 → 約48秒

## 技術的詳細

### 並列化の実装

並列化は`FLoops.jl`を使用して実装されています:
- `par="thread"`: ThreadedEx()バックエンド（並列実行）
- `par="sequential"`: SequentialEx()バックエンド（逐次実行）

### 並列化されている処理

1. RHS（右辺ベクトル）計算
2. ソルバーの内積・AXPY演算
3. 前処理（Preconditioner）

### スケーラビリティの制約要因

1. **メモリバンド幅**: 3スレッド以降で顕著
2. **キャッシュ競合**: 多スレッド時の性能低下
3. **Amdahlの法則**: 逐次部分による理論的上限

## 再現性の確認

2回の独立した測定により、以下が確認されました:
- ほとんどの測定で差分が1秒以内
- 4スレッドのみ3.5秒差（5.7%の変動）
- 全体として良好な再現性を持つ
